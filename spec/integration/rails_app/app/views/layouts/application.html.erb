<!DOCTYPE html>
<html>
<head>
<title>What Happened</title>
  <%= action_cable_meta_tag %>
  <%= csrf_meta_tag %>
  <%= stylesheet_link_tag    'application', media: 'all', 'data-turbolinks-track' => true %>
  <%= javascript_include_tag 'application', 'data-turbolinks-track' => true %>
</head>
<body>
  <!-- Fixed navbar -->
  <nav class="navbar navbar-inverse navbar-fixed-top">
    <div class="container">
      <div class="navbar-header">
        <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false" aria-controls="navbar">
          <span class="sr-only">Toggle navigation</span>
          <span class="icon-bar"></span>
          <span class="icon-bar"></span>
          <span class="icon-bar"></span>
        </button>
        <a class="navbar-brand" href="/">Home</a>
      </div>
      <div id="navbar" class="navbar-collapse collapse">
        <ul class="nav navbar-nav">
          <li>
            <% if current_user.present? -%>
            <a href="<%= user_notifications_path(current_user) -%>">
              My notifications <span id=counter class="badge"><%= current_user.what_happened.count -%></span>
            </a>
            <%= javascript_tag do -%>
            App.cable.subscriptions.create({channel: "NotificationsChannel", recipient: "<%= current_user.to_signed_global_id -%>"}, {
              connected: function() {  },

              disconnected: function() {},

              received: function(data) {
                var count = parseInt(jQuery("#counter").text());
                count = count + 1;
                jQuery("#counter").text(count);
              }});
            <% end -%>
            <% else -%>
            <a href="<%= new_session_path -%>">
              Sign in
            </a>
            <% end -%>
          </li>
          <% if current_user.present? -%>
          <li>
            <%= link_to "Sign out! (Signed in as #{current_user.name})",  session_path("current"),  method: :delete %>
          </li>
          <% end %>
        </ul>
      </div><!--/.nav-collapse -->
    </div>
  </nav>

<%= yield %>

</body>
</html>
